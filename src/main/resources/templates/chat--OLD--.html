<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Spring Chat (Streaming)</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background:#f5f5f5; margin:0; }
    .wrap { max-width: 900px; margin: 30px auto; background:#fff; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.08); display:flex; flex-direction:column; height: 85vh; }
    header { padding:16px 18px; border-bottom:1px solid #eee; font-weight:600; }
    #messages { flex:1; overflow:auto; padding:18px; }
    .msg { margin: 10px 0; line-height:1.45; white-space:pre-wrap; }
    .user { text-align:right; color:#0b57d0; }
    .assistant { text-align:left; color:#222; }
    .composer { border-top:1px solid #eee; padding:12px; display:flex; gap:10px; }
    input { flex:1; padding:10px 12px; font-size:16px; }
    button { padding:10px 14px; font-size:16px; cursor:pointer; }
    .muted { color:#888; font-size: 12px; margin-top: 6px; }
  </style>
</head>

<body>
<div class="wrap">
  <header>Spring Chat (Streaming SSE)</header>

  <div id="messages"></div>

  <div class="composer">
    <input id="messageInput" type="text" placeholder="Type your messageâ€¦"
           onkeydown="if(event.key==='Enter') sendStream()">
    <button onclick="sendStream()">Send</button>
  </div>
</div>

<script>
  function appendMessage(role, text) {
    const messages = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = "msg " + role;
    div.textContent = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    return div;
  }

  async function sendStream() {
    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if (!text) return;

    appendMessage("user", text);
    input.value = "";

    // Create a placeholder for the assistant message and stream into it
    const out = appendMessage("assistant", "");

    const resp = await fetch("/chat/stream", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Accept": "text/event-stream" },
      body: JSON.stringify({ message: text })
    });

    if (!resp.ok || !resp.body) {
      out.textContent = `Error: HTTP ${resp.status}`;
      return;
    }

    const reader = resp.body.getReader();
    const decoder = new TextDecoder("utf-8");

    let buffer = "";
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });

      // SSE frames are separated by blank lines
      const parts = buffer.split("\n\n");
      buffer = parts.pop(); // remainder

      for (const part of parts) {
        // Each frame may have multiple lines; we care about "data:"
        const lines = part.split("\n");
        for (const line of lines) {
          if (line.startsWith("data:")) {
            let chunk = line.slice(5);
            if (chunk.startsWith(" ")) chunk = chunk.slice(1); // remove only the single SSE separator space

            // Do NOT check "if (chunk)" because chunk can be " " (a space) and is important
            if (chunk !== "[DONE]") {
              out.textContent += chunk;
              document.getElementById("messages").scrollTop =
                document.getElementById("messages").scrollHeight;
            }
          }
        }
      }
    }
  }
</script>
</body>
</html>